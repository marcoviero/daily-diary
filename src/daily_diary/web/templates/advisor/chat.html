{% extends "base.html" %}

{% block title %}Doctor's Appointment - Daily Diary{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">ü©∫ Doctor's Appointment</h1>
            <p class="text-gray-600 mt-1">AI Health Advisor - Not a replacement for real medical care</p>
        </div>
        <div class="flex space-x-3">
            <a href="/advisor/history" class="text-teal-600 hover:text-teal-800">üìã Past Visits</a>
            <a href="/" class="text-gray-500 hover:text-gray-700">‚Üê Home</a>
        </div>
    </div>
    
    {% if not is_configured %}
    <!-- Not configured warning -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 mb-6">
        <h2 class="text-lg font-semibold text-yellow-800 mb-2">‚ö†Ô∏è AI Not Configured</h2>
        <p class="text-yellow-700">
            To use the Health Advisor, please add one of these to your <code>.env</code> file:
        </p>
        <ul class="mt-2 text-yellow-700 list-disc list-inside">
            <li><code>ANTHROPIC_API_KEY</code> (preferred)</li>
            <li><code>OPENAI_API_KEY</code> (fallback)</li>
        </ul>
    </div>
    {% else %}
    
    <!-- Disclaimer -->
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
        <p class="text-blue-800 text-sm">
            <strong>‚öïÔ∏è Important:</strong> This AI advisor analyzes your health diary data to provide insights 
            and suggestions. It is <strong>not a substitute for professional medical advice</strong>. 
            Always consult a healthcare provider for medical concerns.
        </p>
    </div>
    
    <!-- Chat Container -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <!-- Chat Header -->
        <div class="bg-gradient-to-r from-teal-600 to-teal-700 px-6 py-4">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-2xl">
                    üë®‚Äç‚öïÔ∏è
                </div>
                <div>
                    <h2 class="text-white font-semibold">Dr. AI Health Advisor</h2>
                    <p id="status-text" class="text-teal-100 text-sm">Ready to start consultation</p>
                </div>
            </div>
        </div>
        
        <!-- Chat Messages -->
        <div id="chat-messages" class="h-96 overflow-y-auto p-6 space-y-4 bg-gray-50">
            <!-- Welcome message -->
            <div class="text-center text-gray-500 py-8">
                <p class="text-lg mb-2">Welcome to your consultation</p>
                <p class="text-sm">Click "Start Consultation" to begin. The advisor will review your recent health data.</p>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="border-t bg-white p-4">
            <div id="start-area" class="text-center">
                <div class="mb-4">
                    <label class="text-sm text-gray-600">Review data from the last </label>
                    <select id="days-select" class="border rounded px-2 py-1 mx-1">
                        <option value="7">7 days</option>
                        <option value="14">14 days</option>
                        <option value="30" selected>30 days</option>
                        <option value="60">60 days</option>
                        <option value="90">90 days</option>
                    </select>
                </div>
                <button onclick="startConsultation()" 
                        class="bg-teal-600 text-white px-8 py-3 rounded-lg hover:bg-teal-700 text-lg font-medium">
                    ü©∫ Start Consultation
                </button>
            </div>
            
            <div id="chat-input-area" class="hidden">
                <form onsubmit="sendMessage(event)" class="flex space-x-3">
                    <input type="text" 
                           id="message-input"
                           placeholder="Describe your concerns or ask a question..."
                           class="flex-1 border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-teal-500"
                           autocomplete="off">
                    <button type="submit" 
                            id="send-btn"
                            class="bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700">
                        Send
                    </button>
                </form>
                <div class="flex justify-between items-center mt-3">
                    <p id="provider-indicator" class="text-xs text-gray-400"></p>
                    <button onclick="endConsultation()" 
                            class="text-sm text-gray-500 hover:text-red-600">
                        End Consultation & Save
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Summary Modal -->
    <div id="summary-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 shadow-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">üìã Visit Summary</h3>
                <button onclick="closeSummaryModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="summary-content" class="space-y-4">
                <!-- Summary will be inserted here -->
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <a href="/advisor/history" class="text-teal-600 hover:text-teal-800">View All Past Visits</a>
                <button onclick="closeSummaryModal()" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">
                    Done
                </button>
            </div>
        </div>
    </div>
    
    <!-- Quick Topics -->
    <div class="mt-6 bg-white rounded-xl shadow p-6">
        <h3 class="font-semibold text-gray-700 mb-3">üí° Topics you might discuss:</h3>
        <div class="flex flex-wrap gap-2">
            <button onclick="suggestTopic('I\\'ve been having headaches lately. Can you see any patterns in my data?')" 
                    class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-sm text-gray-700">
                Headache patterns
            </button>
            <button onclick="suggestTopic('How has my sleep been affecting my symptoms?')" 
                    class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-sm text-gray-700">
                Sleep impact
            </button>
            <button onclick="suggestTopic('Are there any triggers you can identify from my data?')" 
                    class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-sm text-gray-700">
                Identify triggers
            </button>
            <button onclick="suggestTopic('How does weather or pressure affect my symptoms?')" 
                    class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-sm text-gray-700">
                Weather effects
            </button>
            <button onclick="suggestTopic('What lifestyle changes might help based on my data?')" 
                    class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-sm text-gray-700">
                Lifestyle advice
            </button>
            <button onclick="suggestTopic('Can you summarize my overall health trends?')" 
                    class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-sm text-gray-700">
                Health summary
            </button>
        </div>
    </div>
    
    <!-- Past Consultations Preview -->
    {% if past_consultations %}
    <div class="mt-6 bg-white rounded-xl shadow p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-semibold text-gray-700">üìã Recent Visits</h3>
            <a href="/advisor/history" class="text-sm text-teal-600 hover:text-teal-800">View All ‚Üí</a>
        </div>
        <div class="space-y-2">
            {% for c in past_consultations[:3] %}
            <a href="/advisor/consultation/{{ c.id }}" 
               class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-medium text-gray-800">{{ c.consultation_date }}</p>
                        <p class="text-sm text-gray-600 truncate">{{ c.chief_complaint or c.summary[:100] or 'No summary' }}...</p>
                    </div>
                    <span class="text-xs text-gray-400">{{ c.message_count }} messages</span>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% endif %}
</div>

<script>
const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
let consultationStarted = false;

function addMessage(content, isUser = false, isSystem = false) {
    const messagesDiv = document.getElementById('chat-messages');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
    
    const bubble = document.createElement('div');
    
    if (isSystem) {
        bubble.className = 'bg-gray-200 text-gray-600 px-4 py-2 rounded-lg text-sm max-w-md';
    } else if (isUser) {
        bubble.className = 'bg-teal-600 text-white px-4 py-3 rounded-lg max-w-md';
    } else {
        bubble.className = 'bg-white border px-4 py-3 rounded-lg max-w-2xl shadow-sm';
    }
    
    // Convert markdown-like formatting
    let formattedContent = content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n\n/g, '</p><p class="mt-2">')
        .replace(/\n/g, '<br>');
    
    bubble.innerHTML = `<p>${formattedContent}</p>`;
    
    messageDiv.appendChild(bubble);
    messagesDiv.appendChild(messageDiv);
    
    // Scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function setStatus(text) {
    document.getElementById('status-text').textContent = text;
}

async function startConsultation() {
    const days = document.getElementById('days-select').value;
    
    // Clear welcome message
    document.getElementById('chat-messages').innerHTML = '';
    
    // Show loading
    addMessage('Starting consultation...', false, true);
    setStatus('Reviewing your health data...');
    
    try {
        const formData = new FormData();
        formData.append('session_id', sessionId);
        formData.append('days', days);
        
        const response = await fetch('/advisor/start', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        // Clear loading message
        document.getElementById('chat-messages').innerHTML = '';
        
        if (result.success) {
            consultationStarted = true;
            
            // Show chat input
            document.getElementById('start-area').classList.add('hidden');
            document.getElementById('chat-input-area').classList.remove('hidden');
            
            // Add greeting
            addMessage(result.message);
            setStatus('In consultation');
            
            // Show provider
            document.getElementById('provider-indicator').textContent = 
                `Powered by ${result.provider === 'claude' ? 'Claude' : 'OpenAI'}`;
            
            // Focus input
            document.getElementById('message-input').focus();
        } else {
            addMessage('Error: ' + result.error, false, true);
            setStatus('Error starting consultation');
        }
    } catch (error) {
        addMessage('Error: ' + error.message, false, true);
        setStatus('Connection error');
    }
}

async function sendMessage(event) {
    event.preventDefault();
    
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addMessage(message, true);
    input.value = '';
    
    // Disable input while waiting
    input.disabled = true;
    document.getElementById('send-btn').disabled = true;
    setStatus('Thinking...');
    
    try {
        const formData = new FormData();
        formData.append('session_id', sessionId);
        formData.append('message', message);
        
        const response = await fetch('/advisor/message', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            addMessage(result.message);
            setStatus('In consultation');
        } else {
            addMessage('Error: ' + result.error, false, true);
        }
    } catch (error) {
        addMessage('Error: ' + error.message, false, true);
    }
    
    // Re-enable input
    input.disabled = false;
    document.getElementById('send-btn').disabled = false;
    input.focus();
}

async function endConsultation() {
    if (!confirm('End this consultation? A summary will be saved.')) return;
    
    setStatus('Generating summary...');
    
    try {
        const formData = new FormData();
        formData.append('session_id', sessionId);
        
        const response = await fetch('/advisor/end', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success && result.summary) {
            showSummaryModal(result.summary);
        }
    } catch (e) {
        console.error('Error ending consultation:', e);
    }
    
    // Reset UI
    consultationStarted = false;
    document.getElementById('chat-messages').innerHTML = `
        <div class="text-center text-gray-500 py-8">
            <p class="text-lg mb-2">Consultation ended</p>
            <p class="text-sm">Your visit summary has been saved.</p>
        </div>
    `;
    document.getElementById('start-area').classList.remove('hidden');
    document.getElementById('chat-input-area').classList.add('hidden');
    setStatus('Ready to start consultation');
}

function showSummaryModal(summary) {
    const content = document.getElementById('summary-content');
    
    let html = '';
    
    if (summary.chief_complaint) {
        html += `<div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-medium text-gray-700 mb-1">Chief Complaint</h4>
            <p class="text-gray-600">${summary.chief_complaint}</p>
        </div>`;
    }
    
    if (summary.summary) {
        html += `<div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-medium text-gray-700 mb-1">Summary</h4>
            <p class="text-gray-600">${summary.summary}</p>
        </div>`;
    }
    
    if (summary.key_findings) {
        html += `<div class="bg-blue-50 p-4 rounded-lg">
            <h4 class="font-medium text-blue-800 mb-1">üîç Key Findings</h4>
            <p class="text-blue-700 whitespace-pre-line">${summary.key_findings}</p>
        </div>`;
    }
    
    if (summary.patterns_identified) {
        html += `<div class="bg-purple-50 p-4 rounded-lg">
            <h4 class="font-medium text-purple-800 mb-1">üìä Patterns Identified</h4>
            <p class="text-purple-700 whitespace-pre-line">${summary.patterns_identified}</p>
        </div>`;
    }
    
    if (summary.recommendations) {
        html += `<div class="bg-green-50 p-4 rounded-lg">
            <h4 class="font-medium text-green-800 mb-1">üí° Recommendations</h4>
            <p class="text-green-700 whitespace-pre-line">${summary.recommendations}</p>
        </div>`;
    }
    
    if (summary.triggers_discussed) {
        html += `<div class="bg-orange-50 p-4 rounded-lg">
            <h4 class="font-medium text-orange-800 mb-1">‚ö° Triggers Discussed</h4>
            <p class="text-orange-700">${summary.triggers_discussed}</p>
        </div>`;
    }
    
    if (summary.follow_up_actions) {
        html += `<div class="bg-teal-50 p-4 rounded-lg">
            <h4 class="font-medium text-teal-800 mb-1">üìù Follow-up Actions</h4>
            <p class="text-teal-700 whitespace-pre-line">${summary.follow_up_actions}</p>
        </div>`;
    }
    
    content.innerHTML = html || '<p class="text-gray-500">No summary available.</p>';
    
    document.getElementById('summary-modal').classList.remove('hidden');
    document.getElementById('summary-modal').classList.add('flex');
}

function closeSummaryModal() {
    document.getElementById('summary-modal').classList.add('hidden');
    document.getElementById('summary-modal').classList.remove('flex');
}

function suggestTopic(topic) {
    if (!consultationStarted) {
        alert('Please start a consultation first.');
        return;
    }
    
    document.getElementById('message-input').value = topic;
    document.getElementById('message-input').focus();
}
</script>
{% endblock %}
