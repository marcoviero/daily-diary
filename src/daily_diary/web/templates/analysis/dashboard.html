{% extends "base.html" %}

{% block title %}Analysis - Daily Health Diary{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-slate-200">üìä Health Analysis</h1>
    <select onchange="window.location.href='/analysis/?days=' + this.value" 
            class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-slate-200">
        <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 days</option>
        <option value="60" {% if days == 60 %}selected{% endif %}>Last 60 days</option>
        <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 days</option>
        <option value="180" {% if days == 180 %}selected{% endif %}>Last 6 months</option>
        <option value="365" {% if days == 365 %}selected{% endif %}>Last year</option>
    </select>
</div>

{% if summary.get('error') %}
<div class="bg-yellow-900/30 border border-yellow-700 rounded-xl p-6 text-center">
    <div class="text-5xl mb-4">üì≠</div>
    <h2 class="text-xl font-medium text-slate-300 mb-2">Not enough data yet</h2>
    <p class="text-slate-400 mb-6">Start logging entries to see patterns and correlations</p>
    <a href="/entries/new" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700">
        Create Entry
    </a>
</div>
{% else %}

<!-- Summary Cards -->
<div class="grid md:grid-cols-4 gap-4 mb-6">
    <div class="bg-slate-800 rounded-xl shadow p-6">
        <div class="text-3xl font-bold text-indigo-400">{{ summary.period_days }}</div>
        <div class="text-sm text-slate-400">Days with Data</div>
    </div>
    <div class="bg-slate-800 rounded-xl shadow p-6">
        <div class="text-3xl font-bold text-red-400">{{ summary.days_with_symptoms }}</div>
        <div class="text-sm text-slate-400">Days with Headaches ({{ (summary.symptom_rate * 100)|round|int }}%)</div>
    </div>
    <div class="bg-slate-800 rounded-xl shadow p-6">
        <div class="text-3xl font-bold text-green-400">{{ summary.avg_wellbeing|round(1) if summary.avg_wellbeing else '-' }}</div>
        <div class="text-sm text-slate-400">Avg Wellbeing (1-10)</div>
    </div>
    <div class="bg-slate-800 rounded-xl shadow p-6">
        <div class="text-3xl font-bold text-blue-400">{{ summary.avg_sleep_score|round|int if summary.avg_sleep_score else '-' }}</div>
        <div class="text-sm text-slate-400">Avg Sleep Score</div>
    </div>
</div>

<!-- Actionable Insights (Priority Section) -->
{% if actionable_insights %}
<div class="bg-gradient-to-r from-teal-900/50 to-slate-800 rounded-xl shadow p-6 mb-6 border border-teal-700/50">
    <h2 class="text-xl font-semibold mb-4 text-teal-300">üí° Key Insights</h2>
    <div class="space-y-4">
        {% for insight in actionable_insights %}
        <div class="flex items-start gap-4 p-4 rounded-lg 
            {% if insight.priority == 'high' %}bg-red-900/30 border border-red-700/50
            {% elif insight.priority == 'medium' %}bg-yellow-900/30 border border-yellow-700/50
            {% else %}bg-slate-700/50 border border-slate-600{% endif %}">
            <div class="flex-shrink-0 mt-1">
                {% if insight.priority == 'high' %}‚ö†Ô∏è
                {% elif insight.priority == 'medium' %}üìå
                {% else %}üí≠{% endif %}
            </div>
            <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs px-2 py-0.5 rounded-full 
                        {% if insight.category == 'Sleep' %}bg-blue-900 text-blue-300
                        {% elif insight.category == 'Diet' %}bg-orange-900 text-orange-300
                        {% elif insight.category == 'Exercise' %}bg-green-900 text-green-300
                        {% elif insight.category == 'Weather' %}bg-cyan-900 text-cyan-300
                        {% else %}bg-slate-600 text-slate-300{% endif %}">
                        {{ insight.category }}
                    </span>
                    {% if insight.data_quality == 'limited' %}
                    <span class="text-xs text-slate-500">(limited data)</span>
                    {% endif %}
                </div>
                <p class="font-medium text-slate-200 mb-1">{{ insight.insight }}</p>
                <p class="text-sm text-slate-400">{{ insight.recommendation }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Timeline Chart -->
{% if chart_data.get('symptom_timeline') %}
<div class="bg-slate-800 rounded-xl shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4 text-slate-200">üìà Health Timeline</h2>
    <div id="symptom-timeline" style="height: 300px;"></div>
</div>
{% endif %}

<!-- Lag Correlations (Delayed Effects) -->
{% if lag_correlations %}
<div class="bg-slate-800 rounded-xl shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-2 text-slate-200">‚è±Ô∏è Delayed Effects</h2>
    <p class="text-sm text-slate-400 mb-4">These factors show relationships with symptoms at various time delays</p>
    
    <div class="grid md:grid-cols-2 gap-4">
        {% for corr in lag_correlations[:8] %}
        <div class="p-4 rounded-lg border 
            {% if corr.is_significant and corr.correlation < 0 %}border-green-700/50 bg-green-900/20
            {% elif corr.is_significant and corr.correlation > 0 %}border-red-700/50 bg-red-900/20
            {% else %}border-slate-600 bg-slate-700/30{% endif %}">
            <div class="flex justify-between items-start mb-2">
                <span class="font-medium text-slate-200">{{ corr.factor }}</span>
                <div class="text-right">
                    <span class="font-mono text-sm 
                        {% if corr.correlation < 0 %}text-green-400{% else %}text-red-400{% endif %}">
                        r={{ corr.correlation }}
                    </span>
                    {% if corr.is_significant %}
                    <span class="text-xs text-yellow-400 ml-1">‚òÖ</span>
                    {% endif %}
                </div>
            </div>
            <div class="text-xs text-slate-400 mb-1">
                Strongest effect: <span class="text-slate-300">{{ corr.lag_description }}</span>
                <span class="text-slate-500">(n={{ corr.n_samples }})</span>
            </div>
            <p class="text-sm text-slate-400">{{ corr.interpretation }}</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Same-Day Correlations -->
{% if significant_correlations %}
<div class="bg-slate-800 rounded-xl shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-2 text-slate-200">üîó Same-Day Correlations</h2>
    <p class="text-sm text-slate-400 mb-4">Statistically significant relationships (p < 0.05)</p>
    
    <div class="space-y-3">
        {% for corr in significant_correlations %}
        <div class="flex items-center justify-between p-3 rounded-lg
            {% if corr.correlation < 0 %}bg-green-900/30 border border-green-700/50
            {% else %}bg-red-900/30 border border-red-700/50{% endif %}">
            <div class="flex items-center gap-3">
                <span class="font-medium text-slate-200">{{ corr.factor }}</span>
                <span class="text-xs px-2 py-0.5 rounded bg-slate-700 text-slate-300">{{ corr.strength }}</span>
            </div>
            <div class="text-right">
                <span class="font-mono {% if corr.correlation < 0 %}text-green-400{% else %}text-red-400{% endif %}">
                    r={{ "%.2f"|format(corr.correlation) }}
                </span>
                <span class="text-xs text-slate-500 ml-2">p={{ "%.3f"|format(corr.p_value) }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Medication Effectiveness -->
{% if medication_analysis %}
<div class="bg-slate-800 rounded-xl shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4 text-slate-200">üíä Medication Analysis</h2>
    
    <div class="space-y-4">
        {% for med in medication_analysis %}
        <div class="p-4 rounded-lg bg-slate-700/50 border border-slate-600">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <span class="font-medium text-lg text-slate-200">{{ med.medication }}</span>
                    {% if med.dosage %}
                    <span class="text-sm text-slate-400 ml-2">({{ med.dosage }})</span>
                    {% endif %}
                </div>
                <span class="text-sm px-2 py-1 rounded 
                    {% if med.data_quality == 'good' %}bg-green-900/50 text-green-300
                    {% elif med.data_quality == 'limited' %}bg-yellow-900/50 text-yellow-300
                    {% else %}bg-slate-600 text-slate-400{% endif %}">
                    {{ med.data_quality }} data
                </span>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mb-3 text-center">
                <div>
                    <div class="text-2xl font-bold text-indigo-400">{{ med.times_taken }}</div>
                    <div class="text-xs text-slate-400">Times taken</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-slate-300">{{ med.avg_severity_med_days or '-' }}</div>
                    <div class="text-xs text-slate-400">Avg severity (w/ med)</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-slate-300">{{ med.avg_severity_baseline or '-' }}</div>
                    <div class="text-xs text-slate-400">Baseline severity</div>
                </div>
            </div>
            
            {% if med.effectiveness_notes %}
            <ul class="text-sm text-slate-400 space-y-1">
                {% for note in med.effectiveness_notes %}
                <li class="flex items-start gap-2">
                    <span class="text-slate-500">‚Ä¢</span>
                    <span>{{ note }}</span>
                </li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Patterns -->
{% if patterns %}
<div class="bg-slate-800 rounded-xl shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4 text-slate-200">üìÖ Patterns</h2>
    <div class="grid md:grid-cols-2 gap-4">
        {% for pattern in patterns %}
        <div class="p-4 rounded-lg bg-slate-700/50 border border-slate-600">
            <div class="text-sm text-slate-400 mb-1">{{ pattern.pattern_type }}</div>
            <div class="text-slate-200">{{ pattern.description }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Scatter Plots -->
<div class="grid md:grid-cols-2 gap-6 mb-6">
    {% if chart_data.get('pressure_scatter') %}
    <div class="bg-slate-800 rounded-xl shadow p-6">
        <h3 class="text-lg font-semibold mb-4 text-slate-200">Pressure vs Symptoms</h3>
        <div id="pressure-scatter" style="height: 250px;"></div>
    </div>
    {% endif %}
    
    {% if chart_data.get('sleep_scatter') %}
    <div class="bg-slate-800 rounded-xl shadow p-6">
        <h3 class="text-lg font-semibold mb-4 text-slate-200">Sleep vs Symptoms</h3>
        <div id="sleep-scatter" style="height: 250px;"></div>
    </div>
    {% endif %}
</div>

{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
    const chartData = {{ chart_data | tojson | safe }};
    
    const darkLayout = {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { color: '#94a3b8' },
        xaxis: { gridcolor: '#334155', zerolinecolor: '#475569' },
        yaxis: { gridcolor: '#334155', zerolinecolor: '#475569' }
    };
    
    // Health Timeline with proper null handling
    if (chartData.symptom_timeline) {
        const dates = chartData.symptom_timeline.dates;
        const severity = chartData.symptom_timeline.severity;
        const wellbeing = chartData.symptom_timeline.wellbeing || [];
        const sleepScore = chartData.symptom_timeline.sleep_score || [];
        
        const timelineData = [];
        
        // Headache severity (show as bars for discrete events)
        if (severity && severity.some(v => v !== null && v > 0)) {
            timelineData.push({
                x: dates,
                y: severity.map(v => v === null ? 0 : v),
                type: 'bar',
                name: 'Headache Severity',
                marker: { color: 'rgba(239, 68, 68, 0.7)' },
                yaxis: 'y'
            });
        }
        
        // Wellbeing (line, skip nulls)
        if (wellbeing && wellbeing.some(v => v !== null)) {
            const wellbeingFiltered = wellbeing.map((v, i) => ({x: dates[i], y: v}))
                .filter(d => d.y !== null);
            
            timelineData.push({
                x: wellbeingFiltered.map(d => d.x),
                y: wellbeingFiltered.map(d => d.y),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Wellbeing',
                line: { color: '#22c55e', width: 2 },
                marker: { size: 5 },
                yaxis: 'y',
                connectgaps: false
            });
        }
        
        // Sleep score (line, different axis)
        if (sleepScore && sleepScore.some(v => v !== null)) {
            const sleepFiltered = sleepScore.map((v, i) => ({x: dates[i], y: v}))
                .filter(d => d.y !== null);
            
            timelineData.push({
                x: sleepFiltered.map(d => d.x),
                y: sleepFiltered.map(d => d.y),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Sleep Score',
                line: { color: '#3b82f6', width: 2, dash: 'dot' },
                marker: { size: 4 },
                yaxis: 'y2'
            });
        }
        
        if (timelineData.length > 0) {
            Plotly.newPlot('symptom-timeline', timelineData, {
                ...darkLayout,
                margin: { t: 30, r: 60, l: 50, b: 40 },
                xaxis: { ...darkLayout.xaxis, title: '' },
                yaxis: { ...darkLayout.yaxis, title: 'Severity / Wellbeing', range: [0, 10] },
                yaxis2: { 
                    title: 'Sleep Score', 
                    overlaying: 'y', 
                    side: 'right', 
                    range: [0, 100],
                    gridcolor: 'rgba(0,0,0,0)',
                    font: { color: '#3b82f6' }
                },
                legend: { x: 0, y: 1.15, orientation: 'h', font: { color: '#94a3b8' } },
                barmode: 'overlay'
            }, { responsive: true });
        }
    }
    
    // Pressure Scatter
    if (chartData.pressure_scatter && chartData.pressure_scatter.pressure.length > 0) {
        Plotly.newPlot('pressure-scatter', [{
            x: chartData.pressure_scatter.pressure,
            y: chartData.pressure_scatter.severity,
            mode: 'markers',
            type: 'scatter',
            marker: { 
                size: 10, 
                color: chartData.pressure_scatter.severity,
                colorscale: 'RdYlGn',
                reversescale: true,
                opacity: 0.7
            },
            text: chartData.pressure_scatter.dates,
            hovertemplate: '%{text}<br>Pressure: %{x} hPa<br>Severity: %{y}<extra></extra>'
        }], {
            ...darkLayout,
            margin: { t: 20, r: 20, l: 50, b: 40 },
            xaxis: { ...darkLayout.xaxis, title: 'Barometric Pressure (hPa)' },
            yaxis: { ...darkLayout.yaxis, title: 'Severity', range: [0, 10] }
        }, { responsive: true });
    }
    
    // Sleep Scatter
    if (chartData.sleep_scatter && chartData.sleep_scatter.sleep_score.length > 0) {
        Plotly.newPlot('sleep-scatter', [{
            x: chartData.sleep_scatter.sleep_score,
            y: chartData.sleep_scatter.severity,
            mode: 'markers',
            type: 'scatter',
            marker: { 
                size: 10, 
                color: chartData.sleep_scatter.severity,
                colorscale: 'RdYlGn',
                reversescale: true,
                opacity: 0.7
            }
        }], {
            ...darkLayout,
            margin: { t: 20, r: 20, l: 50, b: 40 },
            xaxis: { ...darkLayout.xaxis, title: 'Sleep Score' },
            yaxis: { ...darkLayout.yaxis, title: 'Severity', range: [0, 10] }
        }, { responsive: true });
    }
</script>
{% endblock %}
